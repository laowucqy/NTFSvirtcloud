{% extends 'base.html' %}
{% load mytags %}
{% block content %}
    {% load bootstrap %}
    {% include 'nav_cat_bar.html' %}
    {% include 'error_block.html' %}
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins" id="all">
                    <div class="ibox-title">
                        <h5> 网络信息列表</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>

                    <div class="ibox-content">
                        <form id="asset_form">
                            <div class="col-sm-1" style="padding-left: 0">
                                <a href="#AddInstance"  type=button class="btn btn-sm btn-primary " data-toggle="modal"> 添加网络</a>
                            </div>
                            <div id="export"></div>
                            <table class="table table-striped table-bordered table-hover " id="editable" name="editable">
                                <thead>
                                <tr>
                                    <th class="text-center">网络名称</th>
                                    <th class="text-center">服务器</th>
                                    <th class="text-center">Device</th>
                                    <th class="text-center">Forward</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for host, nets  in all_host_nets.items %}
                                    {% for net in nets %}
                                        <tr>
                                            <td class="text-center"><a href="{% url 'network' host.0 net.name %}">{{ net.name }}</a></td>
                                            <td class="text-center"><a href="#">{{ host.1 }}</a></td>
                                            <td class="text-center">{{ net.device }}</td>
                                            <td class="text-center">{{ net.forward|upper }}</td>
                                        </tr>
                                    {% endfor %}
                                {% endfor %}
                                </tbody>
                            </table>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="dataTables_info" id="editable_info" role="status" aria-live="polite">
                                        Showing {{ compute.start_index }} to {{ compute.end_index }} of {{ p.count }} entries
                                    </div>
                                </div>
                                {% include 'paginator.html' %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal pool -->
    <div class="modal fade" id="AddInstance" tabindex="-1" role="dialog" aria-labelledby="AddNetPoolLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">选择要创建虚拟网络的服务器</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" role="form">
                        <div class="form-group">
                            <label class="col-sm-4 control-label">服务器</label>
                            <div class="col-sm-6">
                                <select class="form-control" id="compute_select">
                                    {% if computes %}
                                        {% for compute in computes %}
                                            <option value="{{ compute.id }}">{{ compute.name }}</option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="None">None</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        关闭
                    </button>
                    {% if computes %}
                        <button type="submit" class="btn btn-primary" name="choose" onclick='goto_network()'>
                            选择
                        </button>
                    {% else %}
                        <button class="btn btn-primary disabled">
                            选择
                        </button>
                    {% endif %}
                </div>
            </div> <!-- /.modal-content -->
        </div> <!-- /.modal-dialog -->
    </div> <!-- /.modal -->
{% endblock %}

{% block self_footer_js %}
    <script>
        $(document).ready(function(){
            $('.server_del').click(function(){
                var row = $(this).closest('tr');
                if (confirm("确定删除?")) {
                    $.get(
                            $(this).attr('value'),
                            {},
                            function (data) {
                                row.remove()
                            }
                    )
                }
            });

        });

        function windowOpen(a){
            var new_url = $(a).attr('href');
            var hostname = $(a).attr('value');
            var title = 'Jumpserver Web Terminal - ' + '<span class="text-info"> '+ hostname +'</span>';
            if (navigator.platform == 'Win32'){
                /*
                 layer.open({
                 type: 2,
                 title: title,
                 maxmin: true,
                 area: ['628px', '420px'],
                 shade: false,
                 content: new_url
                 });
                 */
                window.open(new_url, '_blank')

            } else {
                /*
                 layer.open({
                 type: 2,
                 title: title,
                 maxmin: true,
                 area: ['628px', '452px'],
                 shade: false,
                 content: new_url
                 });
                 */
                window.open(new_url, '_blank');
            }

            return false
        }

        function windowOpenExec(a){
            var new_url = $(a).attr('href');
            var title = 'Jumpserver Exec Terminal';
            layer.open({
                type: 2,
                title: title,
                maxmin: true,
                area: ['725px', '600px'],
                shade: false,
                content: new_url
            });
            return false
        }

        {#        $(".iframe").on('click', function(){#}
        {#            var asset_id_all = getIDall();#}
        {#            if (asset_id_all == ''){#}
        {#                alert("请至少选择一行!");#}
        {#                return false;#}
        {#            }#}
        {#            var url= $(this).attr("value") + '?asset_id_all=' + asset_id_all;#}
        {#            parent.layer.open({#}
        {#                type: 2,#}
        {#                title: 'JumpServer - 批量修改主机',#}
        {#                maxmin: true,#}
        {#                shift: 'top',#}
        {#                border: [2, 0.3, '#1AB394'],#}
        {#                shade: [0.5, '#000000'],#}
        {#                area: ['800px', '600px'],#}
        {#                shadeClose: true,#}
        {#                content: url,#}
        {#                cancel: function(){#}
        {#                    location.replace(location.href);#}
        {#                }#}
        {#            });#}
        {#        });#}

        {#        $('.search-btn-excel').unbind('click').bind('click',function(){#}
        {#            var url= $(this).attr("href");#}
        {#            $.ajax({#}
        {#                type: "GET",#}
        {#                url: url,#}
        {#                data: $("#asset_form").serialize(),#}
        {#                success: function (data) {#}
        {#                    $("#export").html(data);#}
        {#                }#}
        {#            });#}
        {#        });#}

        function change_info(){
            var args = $("#asset_form").serialize();
            window.location = "{% url 'instances' %}?" + args
        }

        $("#search_input").keydown(function(e){
            if(e.keyCode==13){
                change_info()
            }
        });
        function open_console(uuid) {
            window.open("{% url 'console' %}?token=" + uuid, "", "width=850,height=485");
        }
        function goto_network() {
            var compute = $("#compute_select").val();
            window.location = "/network/" + compute + "/create/";
        }
    </script>

{% endblock %}
