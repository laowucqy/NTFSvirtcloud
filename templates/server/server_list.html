{% extends 'base.html' %}
{% load mytags %}
{% block content %}
    {% load bootstrap %}
    {% include 'nav_cat_bar.html' %}
    {% include 'error_block.html' %}
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins" id="all">
                    <div class="ibox-title">
                        <h5> 主机详细信息列表</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>

                    <div class="ibox-content">
                        <form id="asset_form">
                            <div class="col-sm-1" style="padding-left: 0">
                                <a href="{% url 'server_add' %}" class="btn btn-sm btn-primary "> 添加服务器</a>

                            </div>
                            <div class="col-sm-7" style="padding-left: 0px">

                            </div>
                            <div class="col-sm-4" style="padding-right: 0">
                                <div class="input-group inline-group">
                                    <input type="text" class="form-control m-b input-sm" id="search_input" name="keyword" value="{{ keyword }}" placeholder="Search">
                                    <input type="text" style="display: none">
                                    <div class="input-group-btn">
                                        <button id='search_btn' href="{% url 'server_list' %}?search=true" type="button" class="btn btn-sm btn-primary search-btn"  onclick="change_info()">
                                            - 搜索 -
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="export"></div>
                            <table class="table table-striped table-bordered table-hover " id="editable" name="editable">
                                <thead>
                                <tr>
                                    <th class="text-center"> 主机名 </th>
                                    <th class="text-center" name="ip"> IP地址 </th>
                                    <th class="text-center"> 链接状态 </th>
                                    <th class="text-center"> 操作 </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for compute in computes_info %}
                                    <tr class="gradeX">
                                        <td class="text-center hostname"><a href="{% url 'server_detail' %}?id={{ compute.id }}">{{ compute.name }}</a></td>
                                        <td class="text-center"><a href="#">{{ compute.hostname }}</a></td>
                                        {% if compute.status == True %}
                                            <td class="text-center">"Connected"</td>
                                        {% else %}
                                            <td class="text-center">"Not Connected"</td>
                                        {% endif %}
                                        <td class="text-center" data-editable='false'>
                                            <a href="{% url 'server_edit' %}?id={{ compute.id }}" class="btn btn-xs btn-info">编辑</a>
                                            {#                                        <a value="{{ asset.id }}" class="conn btn btn-xs btn-warning">连接</a>#}
                                            <a value="{% url 'server_del' %}?id={{ compute.id }}" class="btn btn-xs btn-danger server_del">删除</a>
                                        </td>
                                    </tr>

                                {% endfor %}
                                {% for asset in assets.object_list %}
                                    <tr class="gradeX">
                                        <td class="text-center hostname"> <a href="{% url 'server_detail' %}?id={{ asset.id }}">{{ asset.hostname|default_if_none:"" }}</a></td>
                                        <td class="text-center"> {{ asset.ip|default_if_none:"" }} </td>
                                        <td class="text-center"> {{ asset.idc.name|default_if_none:"" }} </td>
                                        <td class="text-center">{{ asset.group.all|group_str2 }}</td>
                                        {#                                    <td class="text-center">{{ asset.cpu }}|{{ asset.memory }}|{{ asset.disk }}</td>#}
                                        <td class="text-center">{{ asset.system_type|default_if_none:"" }}{{ asset.system_version|default_if_none:"" }}</td>
                                        <td class="text-center"> {{ asset.cpu|get_cpu_core|default_if_none:"" }} </td>
                                        <td class="text-center"> {{ asset.memory|default_if_none:"" }}{% if asset.memory %}G{% endif %}</td>
                                        <td class="text-center"> {{ asset.disk|get_disk_info }}{% if asset.disk %}G{% endif %}</td>
                                        <td class="text-center" data-editable='false'>
                                            <a href="{% url 'server_edit' %}?id={{ asset.id }}" class="btn btn-xs btn-info">编辑</a>
                                            {#                                        <a value="{{ asset.id }}" class="conn btn btn-xs btn-warning">连接</a>#}
                                            <a value="{% url 'server_del' %}?id={{ asset.id }}" class="btn btn-xs btn-danger asset_del">删除</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="dataTables_info" id="editable_info" role="status" aria-live="polite">
                                        Showing {{ servers.start_index }} to {{ servers.end_index }} of {{ p.count }} entries
                                    </div>
                                </div>
                                {% include 'paginator.html' %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block self_footer_js %}
    <script>
        $(document).ready(function(){
            $('.server_del').click(function(){
                var row = $(this).closest('tr');
                if (confirm("确定删除?")) {
                    $.get(
                            $(this).attr('value'),
                            {},
                            function (data) {
                                row.remove()
                            }
                    )
                }
            });

        });

        function windowOpen(a){
            var new_url = $(a).attr('href');
            var hostname = $(a).attr('value');
            var title = 'Jumpserver Web Terminal - ' + '<span class="text-info"> '+ hostname +'</span>';
            if (navigator.platform == 'Win32'){
                /*
                 layer.open({
                 type: 2,
                 title: title,
                 maxmin: true,
                 area: ['628px', '420px'],
                 shade: false,
                 content: new_url
                 });
                 */
                window.open(new_url, '_blank')

            } else {
                /*
                 layer.open({
                 type: 2,
                 title: title,
                 maxmin: true,
                 area: ['628px', '452px'],
                 shade: false,
                 content: new_url
                 });
                 */
                window.open(new_url, '_blank');
            }

            return false
        }

        function windowOpenExec(a){
            var new_url = $(a).attr('href');
            var title = 'Jumpserver Exec Terminal';
            layer.open({
                type: 2,
                title: title,
                maxmin: true,
                area: ['725px', '600px'],
                shade: false,
                content: new_url
            });
            return false
        }

        {#        $(".iframe").on('click', function(){#}
        {#            var asset_id_all = getIDall();#}
        {#            if (asset_id_all == ''){#}
        {#                alert("请至少选择一行!");#}
        {#                return false;#}
        {#            }#}
        {#            var url= $(this).attr("value") + '?asset_id_all=' + asset_id_all;#}
        {#            parent.layer.open({#}
        {#                type: 2,#}
        {#                title: 'JumpServer - 批量修改主机',#}
        {#                maxmin: true,#}
        {#                shift: 'top',#}
        {#                border: [2, 0.3, '#1AB394'],#}
        {#                shade: [0.5, '#000000'],#}
        {#                area: ['800px', '600px'],#}
        {#                shadeClose: true,#}
        {#                content: url,#}
        {#                cancel: function(){#}
        {#                    location.replace(location.href);#}
        {#                }#}
        {#            });#}
        {#        });#}

        {#        $('.search-btn-excel').unbind('click').bind('click',function(){#}
        {#            var url= $(this).attr("href");#}
        {#            $.ajax({#}
        {#                type: "GET",#}
        {#                url: url,#}
        {#                data: $("#asset_form").serialize(),#}
        {#                success: function (data) {#}
        {#                    $("#export").html(data);#}
        {#                }#}
        {#            });#}
        {#        });#}

        function change_info(){
            var args = $("#asset_form").serialize();
            window.location = "{% url 'server_list' %}?" + args
        }

        $("#search_input").keydown(function(e){
            if(e.keyCode==13){
                change_info()
            }
        });
    </script>

{% endblock %}
