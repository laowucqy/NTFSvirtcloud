{% extends 'base.html' %}
{% load mytags %}
{% block content %}
    {% load bootstrap %}
    {% include 'nav_cat_bar.html' %}
    {% include 'error_block.html' %}
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins" id="all">
                    <div class="ibox-title">
                        <h5> 主机详细信息列表</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>

                    <div class="ibox-content">
                        <form id="asset_form">
                            <div class="col-sm-1" style="padding-left: 0">
                                <a href="#AddInstance"  type=button class="btn btn-sm btn-primary " data-toggle="modal"> 添加虚拟机</a>

                            </div>
                            <div class="col-sm-7" style="padding-left: 0px">
                                <a href="{% url "flavor_list" %}"  type=button class="btn btn-sm btn-primary " data-toggle="modal"> 从flavor启动</a>
                            </div>
                            <div class="col-sm-4" style="padding-right: 0">
                                <div class="input-group inline-group">
                                    <input type="text" class="form-control m-b input-sm" id="search_input" name="keyword" value="{{ keyword }}" placeholder="Search">
                                    <input type="text" style="display: none">
                                    <div class="input-group-btn">
                                        <button id='search_btn' href="{% url 'instances' %}?search=true" type="button" class="btn btn-sm btn-primary search-btn"  onclick="change_info()">
                                            - 搜索 -
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="export"></div>
                            <table class="table table-striped table-bordered table-hover " id="editable" name="editable">
                                <thead>
                                <tr>
                                    <th class="text-center">主机名称</th>
                                    <th class="text-center">服务器<br>用户</th>
                                    <th class="text-center">状态</th>
                                    <th class="text-center">VCPU</th>
                                    <th class="text-center">内存</th>
                                    <th class="text-center" data-sortable="false" style="width:205px;">操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for host, inst  in all_host_vms.items %}
                                    {% for vm, info in inst.items %}
                                        <tr>
                                            <td class="text-center"><a href="{% url 'instance' host.0 vm %}">{{ vm }}</a><br><small><em>{{ info.title }}</em></small></td>
                                            <td class="text-center"><a href="#">{{ host.1 }}</a><br><small><em>{% if info.userinstances.count > 0 %}{{ info.userinstances.first_user.user.username }}{% if info.userinstances.count > 1 %} (+{{ info.userinstances.count|add:"-1" }}){% endif %}{% endif %}</em></small></td>
                                            <td class="text-center">{% ifequal info.status 1 %}
                                                <span class="text-success">开启</span>
                                            {% endifequal %}
                                                {% ifequal info.status 5 %}
                                                    <span class="text-danger">关闭</span>
                                                {% endifequal %}
                                                {% ifequal info.status 3 %}
                                                    <span class="text-warning">挂起</span>
                                                {% endifequal %}
                                            </td>
                                            <td class="text-center">{{ info.vcpu }}</td>
                                            <td class="text-center">{{ info.memory }} MB</td>
                                            <td class="text-center"><form action="" method="post" role="form">{% csrf_token %}
                                                <input type="hidden" name="name" value="{{ vm }}"/>
                                                <input type="hidden" name="compute_id" value="{{ host.0 }}"/>
                                                {% ifequal info.status 5 %}
                                                    {% if info.is_template %}
                                                        <button class="btn btn-sm btn-default" type="button" name="clone" title="克隆" onclick="goto_instance_clone({{ host.0 }}, '{{ vm }}');">
                                                            <span class="glyphicon glyphicon-duplicate"></span>
                                                        </button>
                                                    {% else %}
                                                        <button class="btn btn-sm btn-default" type="submit" name="poweron" title="开机">
                                                            <span class="glyphicon glyphicon-play"></span>
                                                        </button>
                                                    {% endif %}
                                                    <button class="btn btn-sm btn-default disabled" title="挂起">
                                                        <span class="glyphicon glyphicon-pause"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-default disabled" title=" 关闭电源">
                                                        <span class="glyphicon glyphicon-off"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-default disabled" title=" 重启">
                                                        <span class="glyphicon glyphicon-refresh"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-default disabled" title=" vnc控制台">
                                                        <span class="glyphicon glyphicon-eye-open"></span>
                                                    </button>
                                                {% endifequal %}
                                                {% ifequal info.status 3 %}
                                                    <button class="btn btn-sm btn-default" type="submit" name="resume" title="恢复">
                                                        <span class="glyphicon glyphicon-play"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-default disabled" title="挂起">
                                                        <span class="glyphicon glyphicon-pause"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-default disabled" title="关闭电源">
                                                        <span class="glyphicon glyphicon-off"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-default disabled" title="重启">
                                                        <span class="glyphicon glyphicon-refresh"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-default disabled" title="vnc控制台">
                                                        <span class="glyphicon glyphicon-eye-open"></span>
                                                    </button>
                                                {% endifequal %}
                                                {% ifequal info.status 1 %}
                                                    <button class="btn btn-sm btn-default disabled" title="开机">
                                                        <span class="glyphicon glyphicon-play"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-default" type="submit" name="suspend" title="挂起">
                                                        <span class="glyphicon glyphicon-pause"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-default" type="submit" name="poweroff" title="关闭电源" onclick="return confirm('Are you sure?')">
                                                        <span class="glyphicon glyphicon-off"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-default" type="submit" name="powercycle" title="重启" onclick="return confirm('Are you sure?')">
                                                        <span class="glyphicon glyphicon-refresh"></span>
                                                    </button>
                                                    <a href="#" class="btn btn-sm btn-default" onclick='open_console("{{ host.0 }}-{{ info.uuid }}")' title="vnc控制台">
                                                        <span class="glyphicon glyphicon-eye-open"></span>
                                                    </a>
                                                {% endifequal %}
                                            </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% endfor %}
                                </tbody>
                            </table>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="dataTables_info" id="editable_info" role="status" aria-live="polite">
                                        Showing {{ compute.start_index }} to {{ compute.end_index }} of {{ p.count }} entries
                                    </div>
                                </div>
                                {% include 'paginator.html' %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal pool -->
    <div class="modal fade" id="AddInstance" tabindex="-1" role="dialog" aria-labelledby="AddNetPoolLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">选择要创建虚拟机的服务器</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" role="form">
                        <div class="form-group">
                            <label class="col-sm-4 control-label">服务器</label>
                            <div class="col-sm-6">
                                <select class="form-control" id="compute_select">
                                    {% if computes %}
                                        {% for compute in computes %}
                                            <option value="{{ compute.id }}">{{ compute.name }}</option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="None">None</option>
                                    {% endif %}
                                </select>
                            </div>
                            <label class="col-sm-4 control-label">创建方式</label>
                            <div class="col-sm-6">
                                <select class="form-control" id="type_select">
                                    <option value="1">通过flavor创建</option>
                                    <option value="2">通过模板创建</option>
                                    <option value="3">定制</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        关闭
                    </button>
                    {% if computes %}
                        <button type="submit" class="btn btn-primary" name="choose" onclick='goto_compute()'>
                            选择
                        </button>
                    {% else %}
                        <button class="btn btn-primary disabled">
                            选择
                        </button>
                    {% endif %}
                </div>
            </div> <!-- /.modal-content -->
        </div> <!-- /.modal-dialog -->
    </div> <!-- /.modal -->
{% endblock %}

{% block self_footer_js %}
    <script>
        $(document).ready(function(){
            $('.server_del').click(function(){
                var row = $(this).closest('tr');
                if (confirm("确定删除?")) {
                    $.get(
                            $(this).attr('value'),
                            {},
                            function (data) {
                                row.remove()
                            }
                    )
                }
            });

        });

        function windowOpen(a){
            var new_url = $(a).attr('href');
            var hostname = $(a).attr('value');
            var title = 'Jumpserver Web Terminal - ' + '<span class="text-info"> '+ hostname +'</span>';
            if (navigator.platform == 'Win32'){
                /*
                 layer.open({
                 type: 2,
                 title: title,
                 maxmin: true,
                 area: ['628px', '420px'],
                 shade: false,
                 content: new_url
                 });
                 */
                window.open(new_url, '_blank')

            } else {
                /*
                 layer.open({
                 type: 2,
                 title: title,
                 maxmin: true,
                 area: ['628px', '452px'],
                 shade: false,
                 content: new_url
                 });
                 */
                window.open(new_url, '_blank');
            }

            return false
        }

        function windowOpenExec(a){
            var new_url = $(a).attr('href');
            var title = 'Jumpserver Exec Terminal';
            layer.open({
                type: 2,
                title: title,
                maxmin: true,
                area: ['725px', '600px'],
                shade: false,
                content: new_url
            });
            return false
        }

        {#        $(".iframe").on('click', function(){#}
        {#            var asset_id_all = getIDall();#}
        {#            if (asset_id_all == ''){#}
        {#                alert("请至少选择一行!");#}
        {#                return false;#}
        {#            }#}
        {#            var url= $(this).attr("value") + '?asset_id_all=' + asset_id_all;#}
        {#            parent.layer.open({#}
        {#                type: 2,#}
        {#                title: 'JumpServer - 批量修改主机',#}
        {#                maxmin: true,#}
        {#                shift: 'top',#}
        {#                border: [2, 0.3, '#1AB394'],#}
        {#                shade: [0.5, '#000000'],#}
        {#                area: ['800px', '600px'],#}
        {#                shadeClose: true,#}
        {#                content: url,#}
        {#                cancel: function(){#}
        {#                    location.replace(location.href);#}
        {#                }#}
        {#            });#}
        {#        });#}

        {#        $('.search-btn-excel').unbind('click').bind('click',function(){#}
        {#            var url= $(this).attr("href");#}
        {#            $.ajax({#}
        {#                type: "GET",#}
        {#                url: url,#}
        {#                data: $("#asset_form").serialize(),#}
        {#                success: function (data) {#}
        {#                    $("#export").html(data);#}
        {#                }#}
        {#            });#}
        {#        });#}

        function change_info(){
            var args = $("#asset_form").serialize();
            window.location = "{% url 'instances' %}?" + args
        }

        $("#search_input").keydown(function(e){
            if(e.keyCode==13){
                change_info()
            }
        });
        function open_console(uuid) {
            window.open("{% url 'console' %}?token=" + uuid, "", "width=850,height=485");
        }
        function goto_compute() {
            var compute = $("#compute_select").val();
            var type = $("#type_select").val();
            window.location = "/compute/" + compute +"/"+ type + "/create/";
        }
    </script>

{% endblock %}
